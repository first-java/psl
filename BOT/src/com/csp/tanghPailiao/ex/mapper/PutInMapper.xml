<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.csp.tanghPailiao.ex.dao.PutInDao">

	<!-- 自定义结果集,可以将sql语句查询的Resultset结果集与实体类一一对应 -->
	<resultMap type="com.csp.tanghPailiao.entity.PutIn" id="cc">
		<!-- 用于主键的映射 -->
		<!-- <id column="id" property="id" javaType="int" /> -->
		<result column="LOTID" property="lotId" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result column="EACHWEIGHT" property="eachWeight" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result column="BARCODE" property="barcode" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result column="CREATTIME" property="creattime" javaType="java.util.Date"
			jdbcType="VARCHAR" />
		<result column="jing_weight" property="jingWeight" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result column="mes_qty" property="mesQty" javaType="java.lang.Integer"
			jdbcType="VARCHAR" />
		<result column="zh_qty" property="zhQty" javaType="java.lang.Integer"
			jdbcType="VARCHAR" />
		<result column="FGLOTID" property="fgLotId" javaType="java.lang.String"
			jdbcType="VARCHAR" />
		<result column="pian_Qty" property="pianQty" javaType="java.lang.Integer"
			jdbcType="VARCHAR" />
		<result column="bag_Weight" property="bagWeight" javaType="java.lang.String"
			jdbcType="VARCHAR" />

	</resultMap>

	<select id="selLotId" resultType="java.lang.String" resultMap="cc">
		select * from lot@jp
		where
		lot_status = 'COMPLETED' and stage_id =
		'DIEP' and
		operation_rrn=12260835
		and
		lot_ID=#{lotId,jdbcType=VARCHAR}
	</select>

	<select id="selCaseNo" resultType="java.lang.String" resultMap="cc">
		select shelfName,max(caseno) as caseNo from
		( select t.*,t.rowid from
		SYS_PSL.CSP_PL_FGSHELF_goods t where deposit
		=#{deposit,jdbcType=VARCHAR}
		and
		substr(lottype,0,4)=substr(#{lotId,jdbcType=VARCHAR},0,4)
		<if test="deposit =='已分光' ">
			AND
			START1&lt;=#{bin1,jdbcType=VARCHAR}
			AND
			END1>=#{bin1,jdbcType=VARCHAR}
		</if>
		)
		group by
		shelfname
	</select>
	<select id="selCaseNoFG" resultType="java.lang.String"
		resultMap="cc">
		select shelfName,max(caseno) as caseNo from
		SYS_PSL.CSP_PL_FGSHELF_goods
		where deposit=#{deposit,jdbcType=VARCHAR}
		and leixing=#{leiXing,jdbcType=VARCHAR}
		and
		lotType=#{lotId,jdbcType=VARCHAR}
		group by
		shelfname
	</select>

	<select id="selCaseNo1" resultType="java.lang.String" resultMap="cc">
		select shelfName,max(caseno) as caseNo from
		(select t.*,t.rowid from
		SYS_PSL.CSP_PL_FGSHELF_goods t where deposit
		=#{deposit,jdbcType=VARCHAR}
		and
		substr(lottype,0,2)=substr(#{lotId,jdbcType=VARCHAR},0,2)
		<if test="deposit =='已分光' ">
			AND
			START1&lt;=#{bin1,jdbcType=VARCHAR}
			AND
			END1>=#{bin1,jdbcType=VARCHAR}
		</if>
		) group by
		shelfname
	</select>
	<select id="selLabel" resultType="java.lang.String" resultMap="cc">
		select * from( select max(barcode) as barcode from (select
		max(barcode) as barcode
		from SYS_PSL.CSP_LABEL t where barcode
		like
		#{barcode,jdbcType=VARCHAR}
		||'%' group by lotid))
		where barcode is not
		null
	</select>
	<!-- 查询最大的存放量 -->
	<select id="selMax" resultType="java.lang.String" resultMap="cc">
		select maxdeposit from SYS_PSL.CSP_PL_FGSHELF where
		shelfname=#{shelfName,jdbcType=VARCHAR} and
		caseno=#{caseNo,jdbcType=VARCHAR}
	</select>
	<!-- 底板散芯入库明细报表 -->
	<select id="sel10" resultType="java.lang.String" resultMap="cc">
		select * from(select rownum odd,o.* from (select t.* from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing ='底板散芯'
		<if test="bdLotId != null and bdLotId !='' ">
			AND
			createTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			createTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="id != null and id !='' ">
			AND
			outTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			outTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>

		order by createtime desc) o )
		where 1=1
		<if test="barcode != null and barcode !='' ">
			AND
			odd
			>#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}</if>
	</select>

	<select id="selHold" resultType="java.lang.String" resultMap="cc">
		select * from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where bagname
		=#{bagName,jdbcType=VARCHAR} and status=0
	</select>
	<!-- 已分光入库明细报表 -->
	<select id="sel11" resultType="java.lang.String" resultMap="cc">
		select * from( select rownum as baofei_bin1_start1, scTime,
		createtime,
		workid,
		bagname,
		status,
		fgLotid,
		lottype,
		id,
		bin,
		leixing,
		weight,
		bagweight,
		labelweight,
		jing_weight,
		eachweight,
		zh_qty,
		qty,
		chayi,
		percentage,
		mes_qty,
		outtime,
		outworkid,
		chulei,
		flag,
		qcstatus,
		qc_time,
		qc_workid,
		remark
		from ( select scTime,
		createtime,
		workid,
		bagname,
		status,
		fgLotid,
		lottype,
		id,
		bin,
		leixing,
		weight,
		bagweight,
		labelweight,
		jing_weight,
		eachweight,
		zh_qty,
		qty,
		chayi,
		percentage,
		mes_qty,
		outtime,
		outworkid,
		chulei,
		flag,
		remark,
		qcstatus,
		qc_time,
		qc_workid
		from (select
		l.createtime as scTime,
		g.createtime,
		g.workid,
		g.bagname,
		case
		when
		g.status = '0' then
		'在库'
		else
		'已出库'
		end as status,
		g.lotid as fgLotid,
		g.lottype,
		g.id,
		g.bin,
		g.leixing,
		g.weight,
		g.bagweight,
		g.labelweight,
		g.jing_weight,
		g.eachweight,
		g.zh_qty,
		g.qty,
		g.chayi,
		g.percentage,
		g.mes_qty,
		g.outtime,
		g.outworkid,
		g.chulei,
		g.flag,
		g.remark,
		x.status as qcstatus,
		x.createtime as qc_time,
		x.workid as qc_workid
		from
		sys_psl.csp_pl_fgshelf_goods g,

		(select distinct x2.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname)
		x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and
		x2.createtime
		= x1.createtime) x,
		SYS_PSL.CSP_LABEL l
		where g.leixing in
		('分光废料',
		'报废BIN',
		'NG品BIN',
		'分光地料',
		'良品BIN',
		'分光NG品',
		'分光尾料')
		and g.bagname =
		x.bagname(+)
		and g.bagname = l.barcode(+))
		order by createtime desc
		)
		)where
		1=1

		<if test="bdLotId != null and bdLotId !='' ">
			AND
			createTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			createTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="id != null and id !='' ">
			AND
			outTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			outTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="barcode != null and barcode !='' ">
			AND
			baofei_bin1_start1 >#{startTime,jdbcType=VARCHAR} and
			baofei_bin1_start1&lt;=#{endTime,jdbcType=VARCHAR}
		</if>
	</select>
	<select id="selcount" resultType="java.lang.Integer">
		select count(1) qty
		from (select
		l.createtime as scTime,
		g.createtime,
		g.workid,
		g.bagname,
		case
		when
		g.status = '0' then
		'在库'
		else
		'已出库'
		end as status,
		g.lotid as fgLotid,
		g.lottype,
		g.id,
		g.bin,
		g.leixing,
		g.weight,
		g.bagweight,
		g.labelweight,
		g.jing_weight,
		g.eachweight,
		g.zh_qty,
		g.qty,
		g.chayi,
		g.percentage,
		g.mes_qty,
		g.outtime,
		g.outworkid,
		g.chulei,
		g.flag,
		x.status as qcstatus,
		x.createtime as qc_time,
		x.workid as qc_workid
		from
		sys_psl.csp_pl_fgshelf_goods g,

		(select x2.*
		from (select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname)
		x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and x2.createtime
		= x1.createtime) x,
		SYS_PSL.CSP_LABEL l
		where g.leixing in ('分光废料',
		'报废BIN',
		'NG品BIN',
		'分光地料',
		'良品BIN',
		'分光NG品',
		'分光尾料')
		and g.bagname =
		x.bagname(+)
		and g.bagname = l.barcode(+))

	</select>
	<!-- 品质锁住静电袋 -->
	<update id="holdBagName" parameterType="com.csp.tanghPailiao.entity.PutIn">
		update
		sys_psl.csp_pl_fgshelf_goods
		set flag =1 where
		bagname=#{bagName,jdbcType=VARCHAR}

	</update>
	<!-- 品质解锁静电袋 -->
	<update id="holdBagNameUnlock" parameterType="com.csp.tanghPailiao.entity.PutIn">
		update
		sys_psl.csp_pl_fgshelf_goods
		set flag ='' where
		bagname=#{bagName,jdbcType=VARCHAR}

	</update>
	<!-- 分光机看板 ,总投入 -->
	<select id="sel12" resultType="java.lang.String" resultMap="cc">
		select e.eqpt,
		e.fglotid,
		e.lottype,
		e.id,
		e.createtime,
		nvl(p.qty,0) as
		qty,
		nvl(gb.goodbin_qty,0) as goodbin_qty,
		nvl(ng.ng_qty,0) as ng_qty,
		nvl(sc.sc_qty,0) as sc_qty,
		nvl(wl.wl_qty,0) as wl_qty,
		nvl(ngp.ngp_qty,0) as ngp_qty,
		nvl(fl.fl_qty,0) as fl_qty,
		nvl(dl.dl_qty,0) as dl_qty,
		nvl(gb.goodbin_qty,0) +
		nvl(ng.ng_qty,0) +
		nvl(sc.sc_qty,0) +
		nvl(wl.wl_qty,0) +
		nvl(ngp.ngp_qty,0) +
		nvl(fl.fl_qty,0) +
		nvl(dl.dl_qty,0) as total_out_die_qty,
		nvl(p.qty,0) -
		(
		nvl(gb.goodbin_qty,0) +
		nvl(ng.ng_qty,0) +
		nvl(sc.sc_qty,0) +
		nvl(wl.wl_qty,0) +
		nvl(ngp.ngp_qty,0) +
		nvl(fl.fl_qty,0) +
		nvl(dl.dl_qty,0)
		) as now_die_qty
		from sys_psl.csp_fg_eqpt e,
		(
		select
		p.fglotid,
		sum(g.qty) as qty
		from sys_psl.csp_fg_eqptpro p,
		sys_psl.csp_pl_fgshelf_goods g
		where p.bagname=g.bagname
		group by
		p.fglotid
		) p,
		(
		select g.lotid as fglotid,
		sum(qty) as goodbin_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='良品BIN'
		group by g.lotid
		) gb,
		(
		select g.lotid as fglotid,
		sum(qty) as ng_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='NG品BIN'
		group by g.lotid
		) ng,
		(
		select g.lotid as fglotid,
		sum(qty) as sc_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='报废BIN'
		group by g.lotid
		) sc,
		(
		select g.lotid as fglotid,
		sum(qty) as wl_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='分光尾料'
		group by g.lotid
		)
		wl,
		(
		select g.lotid as fglotid,
		sum(qty) as ngp_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='分光NG品'
		group by g.lotid
		) ngp,
		(
		select g.lotid as fglotid,
		sum(qty) as fl_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='分光废料'
		group by g.lotid
		)
		fl,
		(
		select g.lotid as fglotid,
		sum(qty) as dl_qty
		from
		sys_psl.csp_pl_fgshelf_goods g
		where g.leixing='分光地料'
		group by g.lotid
		)
		dl
		where e.status=1
		and e.fglotid=p.fglotid(+)
		and
		e.fglotid=gb.fglotid(+)
		and e.fglotid=ng.fglotid(+)
		and
		e.fglotid=sc.fglotid(+)
		and e.fglotid=wl.fglotid(+)
		and
		e.fglotid=ngp.fglotid(+)
		and e.fglotid=fl.fglotid(+)
		and
		e.fglotid=dl.fglotid(+)
		order by e.fglotid
	</select>

	<!-- 分光机看板 ,总投入 -->
	<select id="sel13" resultType="java.lang.String" resultMap="cc">
		select t1.fglotid,t1.createtime,t1.lottype,sum(mes_qty) as qty,leixing
		from sys_psl.csp_pl_fgshelf_goods t,sys_psl.csp_fg_eqpt t1
		where
		t.lotid=t1.fglotid
		--and t.status!=1
		and
		t1.fglotid=#{fgLotId,jdbcType=VARCHAR}
		and
		t1.lottype=#{lotType,jdbcType=VARCHAR}
		and t1.id=#{id,jdbcType=VARCHAR}
		and leixing=#{leiXing,jdbcType=VARCHAR}
		group by
		t1.fglotid,t1.createtime,t1.lottype,leixing
	</select>
	<!-- -->
	<select id="sel14" resultType="java.lang.String" resultMap="cc">
		select
		odd,eqpt,fglotid,lottype,id,createtime,qty,goodbin_qty,ng_qty,sc_qty
		,wl_qty,ngp_qty,fl_qty,dl_qty,total_out_die_qty,now_die_qty,scTime
		,qcTime from (select rownum
		odd,eqpt,fglotid,lottype,id,createtime,qty,goodbin_qty,ng_qty,sc_qty
		,wl_qty,ngp_qty,fl_qty,dl_qty,total_out_die_qty,now_die_qty,scTime
		,qcTime from (select e.eqpt,
		e.label as fglotid,
		e.lottype,
		e.id,
		e.createtime,
		nvl(p.qty,0) as qty,
		nvl(gb.goodbin_qty,0) as goodbin_qty,
		nvl(ng.ng_qty,0) as ng_qty,
		nvl(sc.sc_qty,0) as sc_qty,
		nvl(wl.wl_qty,0) as wl_qty,
		nvl(ngp.ngp_qty,0) as ngp_qty,
		nvl(fl.fl_qty,0) as fl_qty,
		nvl(dl.dl_qty,0) as dl_qty,

		nvl(gb.goodbin_qty,0) +
		nvl(ng.ng_qty,0) +
		nvl(sc.sc_qty,0) +
		nvl(wl.wl_qty,0) +
		nvl(ngp.ngp_qty,0) +
		nvl(fl.fl_qty,0) +
		nvl(dl.dl_qty,0) as total_out_die_qty,

		nvl(p.qty,0) - (
		nvl(gb.goodbin_qty,0) +
		nvl(ng.ng_qty,0) +
		nvl(sc.sc_qty,0) +
		nvl(wl.wl_qty,0) +
		nvl(ngp.ngp_qty,0) +
		nvl(fl.fl_qty,0) +
		nvl(dl.dl_qty,0)
		) as now_die_qty,

		s.createtime as scTime,
		qc.qingtime as
		qcTime

		from sys_psl.csp_eqpt_label e,
		(
		select p.fglotid,
		sum(g.qty) as
		qty
		from sys_psl.csp_fg_eqptpro p,
		sys_psl.csp_pl_fgshelf_goods g
		where
		p.bagname=g.bagname
		group by p.fglotid
		) p,
		(
		select g.lotid as fglotid,
		sum(qty) as goodbin_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='良品BIN'
		group by g.lotid
		) gb,
		(
		select g.lotid as fglotid,
		sum(qty) as ng_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='NG品BIN'
		group by g.lotid
		) ng,
		(
		select g.lotid as fglotid,
		sum(qty) as sc_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='报废BIN'
		group by g.lotid
		) sc,
		(
		select g.lotid as fglotid,
		sum(qty) as wl_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='分光尾料'
		group by g.lotid
		) wl,
		(
		select g.lotid as fglotid,
		sum(qty) as ngp_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='分光NG品'
		group by g.lotid
		) ngp,
		(
		select g.lotid as fglotid,
		sum(qty) as fl_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='分光废料'
		group by g.lotid
		) fl,
		(
		select g.lotid as fglotid,
		sum(qty) as dl_qty
		from sys_psl.csp_pl_fgshelf_goods g
		where
		g.leixing='分光地料'
		group by g.lotid
		) dl,
		sys_psl.csp_pl_scqj s,
		sys_psl.csp_eqpt_label qc
		where e.label=p.fglotid(+)
		and
		e.label=gb.fglotid(+)
		and e.label=ng.fglotid(+)
		and
		e.label=sc.fglotid(+)
		and e.label=wl.fglotid(+)
		and
		e.label=ngp.fglotid(+)
		and e.label=fl.fglotid(+)
		and
		e.label=dl.fglotid(+)
		and e.label=s.fglotid(+)
		and e.label=qc.label(+)
		AND e.eqpt not like 'SM%'

		order
		by
		e.createtime desc) where 1=1
		<if test="fgLotId != null and fgLotId !='' ">
			and fglotid like '%'|| #{fgLotId,jdbcType=VARCHAR}||'%'
		</if>
		<if test="bdLotId != null and bdLotId !='' ">
			AND
			createtime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			createtime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="lotType != null and lotType !='' ">
			AND
			scTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			scTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="id != null and id !='' ">
			AND
			qcTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			qcTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		order
		by
		createtime desc)where 1=1
		<if test="barcode != null and barcode !='' ">
			and odd>#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}
		</if>

	</select>
	<select id="sel15" resultType="java.lang.String" resultMap="cc">
		--总投入+生产清机时间
		select q.lotid,q.lottype,q.id,q.mesqty,qqq.createtime as
		sctime from ( select
		t.lotid,t.lottype,t.id,sum(mes_qty)mesqty from
		sys_psl.csp_pl_fgshelf_goods t,
		sys_psl.csp_fg_eqptpro t1
		where
		t.lotid=t1.fglotid
		and t.bagname=t1.bagname
		and
		t1.fglotid=#{fgLotId,jdbcType=VARCHAR}
		group by t.lotid,t.lottype,t.id)
		q,sys_psl.csp_pl_scqj qqq
		where q.lotid=qqq.fglotid
	</select>
	<!-- 待分光明细 -->
	<select id="selDFGmingxi" resultType="java.lang.String"
		resultMap="cc">
		select id,LOTTYPE,mesQty,qty,status from( select rownum
		id,LOTTYPE,mesQty,qty,status from(select LOTTYPE, sum(MES_qty) as
		mesQty,count(bagname) as
		qty,status
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS
		where status =0
		<if test="status != null and status !='' ">
			and flag is null
		</if>
		<if test="lotType != null and lotType !='' ">
			and lottype like '%'
			||#{lotType,jdbcType=VARCHAR}||'%'
		</if>
		AND LEIXING
		in('底板散芯',
		'编带尾料',
		'分光尾料',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光',
		'NG品BIN',
		'分光NG品' )
		group by
		LOTTYPE,status
		order by
		LOTTYPE desc))
		where
		1=1
		<if test="barcode != null and barcode !='' ">
			and id>#{startTime,jdbcType=VARCHAR}
			AND
			id&lt;=#{endTime,jdbcType=VARCHAR}
		</if>

	</select>
	<select id="selDFGmingxi3" resultType="java.lang.String"
		resultMap="cc">

		select LOTTYPE, sum(mes_qty) as
		mesQty,count(bagname) as
		qty,status
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS
		where status not in(1,3)
		and
		leixing!='良品BIN'
		AND LEIXING !='报废BIN'
		and lottype like '%'
		||#{lotType,jdbcType=VARCHAR}||'%'
		group by
		LOTTYPE,status
		order by
		LOTTYPE desc
	</select>
	<select id="selDFGmingxi2" resultType="java.lang.String"
		resultMap="cc">

		select * from
		SYS_PSL.CSP_PL_FGSHELF_GOODS
		where
		lottype=#{lotId,jdbcType=VARCHAR}
		and status !=1
		<choose>
			<when test="status!= null and status!=''">
				and 1=1
			</when>
			<otherwise>
				and flag is null
			</otherwise>
		</choose>
		and LEIXING
		in('底板散芯',
		'编带尾料',
		'分光尾料',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光',
		'NG品BIN',
		'分光NG品' )
		order by
		LEIXING desc,createtime

	</select>

	<!-- 待分光明细 -->
	<select id="selYFGmingxi" resultType="java.lang.String"
		resultMap="cc">
		select id, typeidbin,lottype,qty,bag_num from(select rownum id,
		typeidbin,lottype,qty,bag_num from( select g.lottype
		|| '-' || g.id ||
		'-' || bin as typeidbin,
		--g.flag,
		g.lottype,
		sum(qty)
		as qty,
		count(1) as
		bag_num
		from (
		select
		g.lottype,
		g.bin,
		g.id,
		g.flag,
		g.qty,
		g.bagname,
		g.createtime,
		g.lotid
		from
		sys_psl.csp_pl_fgshelf_goods g
		,
		(select
		bagname,status from
		sys_psl.csp_pl_qc where createtime in(
		select
		max(createtime) from
		sys_psl.csp_pl_qc group by bagname )) q
		where
		g.status=0
		and
		q.status='OK'
		<choose>
			<when test="status!= null and status!=''">
				and 1=1
			</when>
			<otherwise>
				and flag is null
			</otherwise>
		</choose>
		and g.bagname=q.bagname
		and g.leixing in
		( '良品BIN')
		) g

		group by g.lottype
		|| '-' || g.id || '-' || bin , g.lottype
		-- g.flag
		order by
		g.lottype ||
		'-' || g.id || '-' || bin , qty desc
		))
		where 1=1
		<if test="barcode != null and barcode !='' ">
			and id>#{startTime,jdbcType=VARCHAR}
			AND
			id&lt;=#{endTime,jdbcType=VARCHAR}
		</if>

	</select>
	<!-- 待分光明细 -->
	<select id="selYFGmingxi2" resultType="java.lang.String"
		resultMap="cc">
		select distinct * from( select g.bagname,
		g.lottype,
		g.id,
		g.bin,
		g.qty,
		g.createtime,
		g.lotid
		,g.flag
		from SYS_PSL.CSP_PL_FGSHELF_GOODS g,
		(select bagname,status from
		sys_psl.csp_pl_qc where createtime in(
		select max(createtime) from
		sys_psl.csp_pl_qc group by bagname )) q
		where leixing='良品BIN'and
		g.status!=1
		and
		q.status='OK'
		and
		g.bagname=q.bagname
		<choose>
			<when test="status!= null and status!=''">
				and 1=1
			</when>
			<otherwise>
				and flag is null
			</otherwise>
		</choose>
		and
		lottype=#{lotType,jdbcType=VARCHAR}
		and id=#{id,jdbcType=VARCHAR}
		and
		bin=#{bin,jdbcType=VARCHAR}
		order by lottype)
	</select>
	<select id="selYFGmingxi3" resultType="java.lang.String"
		resultMap="cc">
		select * from(select rownum odd,t.* from (select * from ( select
		g.lottype || '-' || g.id || '-' ||
		bin as
		typeidbin,
		g.flag, g.lottype,
		sum(qty) as qty,
		count(1) as bag_num
		from (
		select
		g.lottype,
		g.bin,
		g.id,
		g.flag,
		g.qty,
		g.bagname,
		g.createtime,
		g.lotid
		from
		sys_psl.csp_pl_fgshelf_goods g ,
		(select bagname,status from
		sys_psl.csp_pl_qc where createtime in( select max(createtime) from
		sys_psl.csp_pl_qc group by bagname )) q
		where g.status=0
		and
		q.status='OK'
		<choose>
			<when test="status!= null and status!=''">
				and 1=1
			</when>
			<otherwise>
				and flag is null
			</otherwise>
		</choose>
		and g.bagname=q.bagname
		and g.leixing in
		( '良品BIN')
		) g
		group by g.lottype
		|| '-' || g.id || '-' || bin , g.lottype,
		g.flag
		)
		where typeidbin like
		'%' ||#{lotId,jdbcType=VARCHAR}||'%'
		order by
		typeidbin , qty
		desc)t)where 1=1
		<if test="barcode != null and barcode !='' ">
			and odd>#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}
		</if>

	</select>

	<!-- 已經存放的數量 -->
	<select id="selGoodsQty" resultType="java.lang.String"
		resultMap="cc">
		select sum(qty) as qty from sys_psl.csp_pl_fgshelf_goods
		where
		shelfname=#{shelfName,jdbcType=VARCHAR} and
		caseno=#{caseNo,jdbcType=VARCHAR}
		group by shelfname,caseno
	</select>

	<select id="selectLiang" resultType="java.lang.String"
		resultMap="cc">
		select * from SYS_PSL.CSP_LABEL where barcode
		=#{bagName,jdbcType=VARCHAR}
	</select>

	<insert id="saveLabel" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		SYS_PSL.CSP_LABEL
		(barcode,createtime,lotId,binId,workId,shelfName,caseNo,leiXing,sexian)
		values(#{barcode,jdbcType=VARCHAR},sysdate,#{lotId,jdbcType=VARCHAR},
		#{binId,jdbcType=VARCHAR},#{workId,jdbcType=VARCHAR},
		#{shelfName,jdbcType=VARCHAR},#{caseNo,jdbcType=VARCHAR},#{leiXing,jdbcType=VARCHAR},#{sexian,jdbcType=VARCHAR})
	</insert>
	<insert id="fgRange1" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		sys_psl.CSP_GOOD_PRO_RANGE
		(MINRANGE,MAXRANGE,createtime,workId )
		values(#{zdpMin,jdbcType=VARCHAR},#{zdpMax,jdbcType=VARCHAR},sysdate,
		#{workId,jdbcType=VARCHAR})
	</insert>


	<select id="selJisu" resultType="java.lang.String" resultMap="cc">

		select u.lot_id,
		u.qty1 as zhQty,
		sum(qty) as qty ,
		count(1) as pianQty
		from
		(
		SELECT l.lot_id,
		l.qty1,
		l.create_category,
		l.created_timestamp,
		l.lot_status,
		l.stage_id,
		t.qty
		FROM lot@jpmycim2 l,
		unit@jpmycim2 u,
		(
		select *
		from cnt_unit_qty_info@jp
		where finish_flag=1
		) t
		WHERE
		l.lot_rrn=u.lot_rrn
		and u.unit_id=t.unit_id(+)
		and
		u.unit_rrn=t.unit_rrn(+)
		and l.lot_status='COMPLETED'
		and
		l.operation_rrn=12260835

		) u
		where
		lot_id=#{lotId,jdbcType=VARCHAR}
		group
		by u.lot_id,u.qty1

	</select>

	<select id="selJisuPian" resultType="java.lang.String"
		resultMap="cc">

		SELECT l.lot_id as lotId,
		oo.specid as id,
		l.end_timestamp as
		created_timestamp, ----以前制程的结束时间来作为分选的开始时间
		u.unit_id as binUnitId,
		l.end_timestamp AS
		last_timestamp, ----以前制程的结束时间来作为最后一次操作时间
		nvl(bad.diep_bad_die_qty,0) AS
		diep_bad_die_qty,
		to_number(o.theory_num) as theory_num, ----理论颗粒数
		case
		when t.qty is not
		null then t.qty else to_number(o.theory_num) -
		nvl(bad.diep_bad_die_qty,0) end - nvl(ubr.sort_die_qty,0) -
		nvl(ftr.tape_die_qty,0) as qty ----理论颗粒数减去数据采集不良数

		from
		lot@jpmycim2 l,
		unit@jpmycim2 u,
		named_object@jpmycim2 no,
		(
		SELECT
		C.KEY_1_VALUE AS
		CATEGORY_ID,
		C.DATA_1_VALUE AS CATEGORY_DESC
		FROM
		REFERENCE_FILE_DETAIL@jpmycim2 C
		WHERE C.REFERENCE_FILE_RRN=59058
		) C,
		(
		SELECT no.instance_rrn,
		o.attribute_value AS theory_num
		FROM (select *
		from object_attribute_value@jpmycim2 WHERE
		field_rrn=4824450) o,
		(select * from named_object@jpmycim2 WHERE OBJECT='PRODUCT') no
		WHERE
		NO.instance_rrn=o.instance_rrn(+)
		) o,
		(
		SELECT unit_rrn,
		SUM(VALUE_string) AS diep_bad_die_qty
		FROM csp_run_detail@jp
		WHERE
		project_id IN
		(
		SELECT ID
		FROM jpcsp.csp_a_items
		WHERE is_num=1
		)
		and
		regexp_like(value_string, '^[0-9]+$')
		GROUP BY unit_rrn
		) bad,
		(
		select
		ubr.unit_id,
		sum(die_qty) as sort_die_qty
		from
		unit_bin_relation@jpmycim2 ubr
		group by ubr.unit_id
		) ubr,
		(
		select
		film_id,
		sum(die_qty) as tape_die_qty
		from film_tape_relation@jpmycim2
		group by film_id
		) ftr,
		(select * from cnt_unit_qty_info@jp where
		finish_flag=1) t,
		(select * from ODS.EL_RESORTING_BINSTAT_INFO@JP) oo
		where l.lot_status='COMPLETED'
		and l.stage_id='DIEP'
		and
		l.lot_rrn=u.lot_rrn
		and l.product_rrn=no.instance_rrn
		and
		l.create_category=c.category_id
		and l.product_rrn=o.instance_rrn(+)
		and
		u.unit_rrn=bad.unit_rrn(+)
		and u.unit_id=ubr.unit_id(+)
		and
		u.unit_id=ftr.film_id(+)
		and u.unit_rrn=t.unit_rrn(+)
		and
		l.operation_rrn not in
		(12317751,12317750,12260835,12397665,12978289,12978307)
		and
		u.unit_id=oo.epi_id
		and u.unit_id =#{lotId,jdbcType=VARCHAR}
	</select>

	<select id="selRecipe" resultType="java.lang.String" resultMap="cc">
		select specid as id from ODS.EL_RESORTING_BINSTAT_INFO@jp t where
		epi_id=#{lotId,jdbcType=VARCHAR}
	</select>

	<select id="selBinUnitId" resultType="java.lang.String"
		resultMap="cc">
		select substr(l.unit_id,0,7 )as lotHead
		,p.bin_unit_id AS
		binUnitId, p.qty-nvl(l.qty,0) as qty from ( select u.bin_unit_id,
		u.die_qty-o.die_qty as qty
		from
		bin_unit_data@jp u,
		Film_tape_relation@jp o
		where u.bin_unit_id=o.film_id
		and
		o.film_id=#{lotId,jdbcType=VARCHAR}
		) p,( select unit_id, sum(die_qty)
		as qty from unit_bin_relation@jp
		where
		bin_unit_id=#{lotId,jdbcType=VARCHAR} group by unit_id) l
		where
		p.bin_unit_id= l.unit_id(+)

	</select>
	<select id="selBinUnitId2" resultType="java.lang.String"
		resultMap="cc">

		select substr(l.lot_id,4,7) lotHead ,
		bud.bin_unit_id
		binUnitId,
		case when t.qty is not null then t.qty else bud.die_qty end
		-
		nvl(ftr.tape_die_qty,0) - nvl(ubr.sort_die_qty,0) AS qty
		----理论颗粒数减去数据采集不良数
		from lot@jp l,
		unit@jp u,
		bin_unit_data@jp bud,
		(
		select film_id,
		max(createtime) as createtime,
		sum(die_qty) as
		tape_die_qty
		from film_tape_relation@jp
		group by film_id
		) ftr,
		(
		select
		unit_id,
		max(createtime) as createtime,
		sum(die_qty) as sort_die_qty
		from unit_bin_relation@jp
		group by unit_id
		) ubr,
		(select * from
		cnt_unit_qty_info@jp where finish_flag=1) t
		where l.lot_rrn=u.lot_rrn
		AND l.lot_status='COMPLETED'
		AND l.stage_id='DIEB'
		and
		u.unit_id=bud.bin_unit_id(+)
		and (bud.bin_flag is null or
		bud.bin_flag!=-1)
		and u.unit_id=ftr.film_id(+)
		and
		u.unit_id=ubr.unit_id(+)
		and u.unit_rrn=t.unit_rrn(+)
		and not exists
		(select 1 from csp_tape@jpmycim2 c where
		u.unit_id=c.unit_id)
		and not
		exists (select 1 from cover_film_data@jpmycim2 c where
		u.unit_id=c.unit_id)
		AND NOT EXISTS
		(SELECT 1 FROM JP_t_stock@jpmycim2 j
		WHERE
		j.barcode_id=u.unit_id) and
		bud.bin_unit_id
		=#{lotId,jdbcType=VARCHAR}
	</select>

	<select id="selCal" resultType="java.lang.String" resultMap="cc">
		select * from SYS_PSL.CSP_CALCULATE where
		lothead LIKE
		#{lotId,jdbcType=VARCHAR}||'%'
		<if test="id != null and id !='' ">
			and id=#{id,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="getEachWeight" resultType="java.lang.String"
		resultMap="cc">
		SELECT * FROM sys_psl.csp_pl_fgshelf_goods WHERE LOTTYPE=
		#{lotType,jdbcType=VARCHAR}
		<if test="id != null and id !='' ">
			and id=#{id,jdbcType=VARCHAR}
		</if>
	</select>

	<!-- 保存货架存放袋子 -->
	<insert id="saveGoods" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		SYS_PSL.CSP_PL_FGSHELF_goods
		(shelfName,caseNo,workId,createtime,bagname,status,deposit,
		bin,qty,lotid,JING_WEIGHT,WEIGHT,mes_Qty,zh_Qty,chayi,percentage,pian_qty,EACHWEIGHT,leixing,lottype,labelQty,
		bagWeight,
		labelWeight,start1,end1,id,sexian,remark)
		values(
		#{shelfName,jdbcType=VARCHAR},#{caseNo,jdbcType=VARCHAR},
		#{workId,jdbcType=VARCHAR},sysdate,#{bagName,jdbcType=VARCHAR},
		#{status,jdbcType=VARCHAR},#{deposit,jdbcType=VARCHAR},
		#{bin,jdbcType=VARCHAR},#{qty,jdbcType=VARCHAR},#{lotId,jdbcType=VARCHAR},
		#{jingWeight,jdbcType=VARCHAR},#{weight,jdbcType=VARCHAR},
		#{mesQty,jdbcType=VARCHAR},#{zhQty,jdbcType=VARCHAR},
		#{chayi,jdbcType=VARCHAR},#{percentage,jdbcType=VARCHAR},#{pianQty,jdbcType=VARCHAR}
		,#{eachWeight,jdbcType=VARCHAR},#{leiXing,jdbcType=VARCHAR},#{lotType,jdbcType=VARCHAR},
		#{labelQty,jdbcType=VARCHAR},#{bagWeight,jdbcType=VARCHAR},
		#{labelWeight,jdbcType=VARCHAR},#{start1,jdbcType=VARCHAR},#{end1,jdbcType=VARCHAR},
		#{id,jdbcType=VARCHAR},#{sexian,jdbcType=VARCHAR},#{remark,jdbcType=VARCHAR})
	</insert>

	<insert id="saveBagHe" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		SYS_PSL.CSP_BAG_HEDAI
		(bagname,bagname1,deposit,lottype,qty,jingweight,workId,createtime,zhqty,weight)
		values(
		#{bagName,jdbcType=VARCHAR},#{bagName1,jdbcType=VARCHAR},
		#{deposit,jdbcType=VARCHAR},#{lotType,jdbcType=VARCHAR},
		#{qty,jdbcType=VARCHAR},#{jingWeight,jdbcType=VARCHAR},
		#{workId,jdbcType=VARCHAR},sysdate,#{zhQty,jdbcType=VARCHAR},#{weight,jdbcType=VARCHAR})
	</insert>

	<insert id="saveHistory" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		sys_psl.csp_fg_ruku( fglotid,bagname ,intime,qty)
		values(
		#{fgLotId,jdbcType=VARCHAR},#{bagName,jdbcType=VARCHAR},sysdate,#{qty,jdbcType=VARCHAR})
	</insert>
	<select id="selNewCase" resultType="java.lang.String" resultMap="cc">
		SELECT shelfname,min(caseno) as caseNo from( select * from (SELECT
		shelfname,min(caseno) as
		caseno,bin,substr(BIN,1,instr(BIN,'-')-1)as
		start1,substr(BIN,instr(BIN,'-')+1,length(BIN)-instr(BIN,'-')) as
		end1
		FROM
		(SELECT DISTINCT * FROM (select
		SHELFNAME,CASENO,SERI,WORKID,CREATETIME,
		regexp_substr(product,'[^,]+', 1, Level,'i') product
		,STATUS,DEPOSIT,BIN,MAXDEPOSIT,QTY from SYS_PSL.CSP_PL_FGSHELF
		connect
		by Level &lt;= LENGTH(product) -
		LENGTH(REGEXP_REPLACE(product, ',',
		'')) + 1 )
		ORDER BY
		SHELFNAME,CASENO)
		WHERE #{lotId,jdbcType=VARCHAR}
		like
		product||'%'
		and
		deposit
		=#{deposit,jdbcType=VARCHAR} and
		caseNo not
		in(
		select caseno
		from(
		select sum(qty), shelfname,caseno
		from
		SYS_PSL.CSP_PL_FGSHELF_goods
		where caseno is not null
		group by
		shelfname,caseno))
		group by
		shelfname,bin)
		<if test="bin1 != null and bin1 !='' ">
			where
			#{bin1,jdbcType=VARCHAR}>=start1
			and
			#{bin1,jdbcType=VARCHAR}&lt;=end1
		</if>
		) group by shelfname
	</select>
	<select id="selOthers" resultType="java.lang.String" resultMap="cc">
		select * from SYS_PSL.CSP_PL_FGSHELF where product='其他' and
		deposit=#{deposit,jdbcType=VARCHAR}
	</select>
	<select id="selBin" resultType="java.lang.String" resultMap="cc">
		select * from (SELECT
		shelfname,
		caseno,bin,substr(BIN,1,instr(BIN,'-')-1)as
		start1,substr(BIN,instr(BIN,'-')+1,length(BIN)-instr(BIN,'-')) as
		end1
		FROM
		(SELECT DISTINCT * FROM (select
		SHELFNAME,CASENO,SERI,WORKID,CREATETIME,
		regexp_substr(product,'[^,]+', 1, Level,'i') product
		,STATUS,DEPOSIT,BIN,MAXDEPOSIT,QTY from SYS_PSL.CSP_PL_FGSHELF
		connect
		by Level &lt;= LENGTH(product) -
		LENGTH(REGEXP_REPLACE(product, ',',
		'')) + 1 )
		ORDER BY
		SHELFNAME,CASENO)
		WHERE
		DEPOSIT='已分光')
		where
		shelfname=#{shelfName,jdbcType=VARCHAR}
		and
		caseno=#{caseNo,jdbcType=VARCHAR}
	</select>
	<insert id="saveQcChk" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		SYS_PSL.CSP_PL_QC
		(bagname,status,workId,createtime)
		values(#{bagName,jdbcType=VARCHAR},#{status,jdbcType=VARCHAR},
		#{workId,jdbcType=VARCHAR},
		sysdate)
	</insert>
	<select id="selectWeiLiao" resultType="java.lang.String"
		resultMap="cc">
		select * from(select rownum odd,o.* from (select t.* from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t where leixing
		in('编带尾料')

		<if test="bdLotId != null and bdLotId !='' ">
			AND
			createTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			createTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		<if test="id != null and id !='' ">
			AND
			outTime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			outTime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>

		order by createtime desc) o ) where 1=1
		<if test="barcode != null and barcode !='' ">
			AND
			odd
			>#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="barcodeTo" resultType="java.lang.String" resultMap="cc">
		select *from ( SELECT c.createtime,
		c.workid,
		c.lothead,
		c.barcode,
		c.qty,
		s.total_out_die_qty,
		c.bagname,
		g.flag,
		g.weight,
		g.bagweight,
		g.labelweight,
		g.jing_weight,
		g.eachweight,
		g.zh_qty,
		case when
		g.zh_qty>s.total_out_die_qty then s.total_out_die_qty else
		g.zh_qty end
		as now_die_qty,
		case when s.total_out_die_qty>=g.zh_qty then
		s.total_out_die_qty-g.zh_qty
		else 0 end as ng_qty,
		g.outtime,
		g.outworkid,
		g.chulei
		FROM sys_psl.csp_barcodetofg c,
		(
		select bagname,
		sum(qty) as total_out_die_qty
		from sys_psl.csp_barcodetofg
		group by
		bagname
		) s,
		sys_psl.csp_pl_fgshelf_goods g
		where c.bagname=s.bagname(+)
		and c.bagname=g.bagname(+)

		<if test="id != null and id !='' ">
			AND
			c.createtime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			c.createtime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		)order by createtime desc,bagweight
	</select>


	<select id="barcodeTo2" resultType="java.lang.String" resultMap="cc">
		select ODD,createtime,
    workid,
    remark1 remark,
    lottype,
    qty,--原始总数量
    bagname,
    flag,
    weight,
    bagweight,
    labelweight,
    jing_weight,
    eachweight,
    zh_qty,
    mes_qty,
    chayi,
    outtime,
    outworkid,
    chulei
    from(
    select ROWNUM ODD,createtime,
    workid,
    lottype,
    qty,--原始总数量
    remark remark1,
    bagname,
    flag,
    weight,
    bagweight,
    labelweight,
    jing_weight,
    eachweight,
    zh_qty,
    mes_qty,
    chayi,remark,
    outtime,
    outworkid,
    chulei
    from(select g.createtime,
    g.workid,
    g.lottype,
    n.qty,--原始总数量
    b.remark,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,

    case
    when n.qty >
    g.zh_qty then
    g.zh_qty
    else
    n.qty
    end as mes_qty,
    case
    when n.qty > g.zh_qty then
    n.qty -
    g.mes_qty
    else
    0
    end as chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods g,
    (select h.bagname, sum(h.qty)
    qty,remark
    from sys_psl.csp_bag_hedai h,
    (select
    BAGNAME,remark, sum(qty)
    qty
    from sys_psl.csp_barcodetofg
    group by bagname,remark) b
    where
    h.bagname1 = b.bagname(+)
    group by h.bagname,remark) b,
    (select sum(qty)
    qty, bagname
    from sys_psl.csp_bag_hedai
    where deposit = '卷轴转分光'
    group by
    bagname) n
    where b.bagname = g.bagname
    and b.bagname = n.bagname
    union

    select
    g.createtime,
    g.workid,
    g.lottype,
    b.qty,
    b.remark,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,
    case
    when b.qty >
    g.zh_qty then
    g.zh_qty
    else
    b.qty
    end as mes_qty,
    case
    when
    b.qty > g.zh_qty
    then
    b.qty - g.zh_qty
    else
    0
    end as chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods g,
    (select
    sum(qty) qty,BAGNAME,remark from sys_psl.csp_barcodetofg group
    by
    BAGNAME,remark) b
    where g.bagname =
    b.bagname
    order by
    createtime desc,
    bagname))
    where 1=1
		<if test="barcode != null and barcode !='' ">
			AND odd >#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="barcodeTo4" resultType="java.lang.String" resultMap="cc">
		select g.createtime,
    g.workid,
    g.lottype,
    b.qty,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,
    g.remark,
    case
    when n.qty > g.zh_qty then
    g.zh_qty
    else
    n.qty
    end
    as mes_qty,
    case
    when n.qty > g.zh_qty then
    n.qty -
    g.zh_qty
    else
    0
    end
    as chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods g,
    (select h.bagname, sum(h.qty) qty
    from
    sys_psl.csp_bag_hedai h,
    (select
    BAGNAME, sum(qty) qty
    from
    sys_psl.csp_fenxuantofg
    group by bagname) b
    where h.bagname1 = b.bagname(+)
    group by h.bagname) b,(select sum(qty)
    qty,bagname
    from sys_psl.csp_bag_hedai where deposit='分选底板转分光'
    group by
    bagname) n
    where
    b.bagname = g.bagname
    and b.bagname=n.bagname
    union
    select
    g.createtime,
    g.workid,
    g.lottype,
    b.qty,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,
    g.remark,
    case
    when b.qty >
    g.zh_qty then
    g.zh_qty
    else
    b.qty
    end as mes_qty,
    case
    when b.qty >
    g.zh_qty then
    b.qty - g.zh_qty
    else
    0
    end as chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods g,
    (select
    sum(qty)qty ,BAGNAME from
    sys_psl.csp_fenxuantofg
    group by
    bagname) b
    where g.bagname =
    b.bagname
    order by
    createtime desc, bagname
	</select>


	<select id="fenxuanTo" resultType="java.lang.String" resultMap="cc">
		select *from ( SELECT c.createtime,
		c.workid,
		c.lothead,
		c.barcode,
		c.qty,
		s.total_out_die_qty,
		c.bagname,
		g.flag,
		g.weight,
		g.bagweight,
		g.labelweight,
		g.jing_weight,
		g.eachweight,
		g.zh_qty,
		case when
		g.zh_qty>s.total_out_die_qty then s.total_out_die_qty else
		g.zh_qty end
		as now_die_qty,
		case when s.total_out_die_qty>=g.zh_qty then
		s.total_out_die_qty-g.zh_qty
		else 0 end as ng_qty,
		g.outtime,
		g.outworkid,
		g.chulei
		FROM sys_psl.csp_fenxuantofg c,
		(
		select bagname,
		sum(qty) as total_out_die_qty
		from sys_psl.csp_fenxuantofg
		group by
		bagname
		) s,
		sys_psl.csp_pl_fgshelf_goods g
		where c.bagname=s.bagname(+)
		and c.bagname=g.bagname(+)
		<if test="id != null and id !='' ">
			AND
			c.createtime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			c.createtime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		)
		order by createtime desc ,bagname
	</select>

	<select id="binUnitIdTo" resultType="java.lang.String"
		resultMap="cc">
		select *from ( SELECT c.createtime,
		c.workid,
		c.lothead,
		c.binunitid,
		c.qty,
		s.total_out_die_qty,
		c.bagname,
		g.flag,
		g.weight,
		g.bagweight,
		g.labelweight,
		g.jing_weight,
		g.eachweight,
		g.zh_qty,
		case when
		g.zh_qty>s.total_out_die_qty then s.total_out_die_qty else
		g.zh_qty end
		as now_die_qty,
		case when s.total_out_die_qty>=g.zh_qty then
		s.total_out_die_qty-g.zh_qty
		else 0 end as ng_qty,
		g.outtime,
		g.outworkid,
		g.chulei
		FROM sys_psl.csp_binunitidtofg c,
		(
		select bagname,
		sum(qty) as total_out_die_qty
		from sys_psl.csp_binunitidtofg
		group by
		bagname
		) s,
		sys_psl.csp_pl_fgshelf_goods g
		where c.bagname=s.bagname(+)
		and c.bagname=g.bagname(+)
		<if test="id != null and id !='' ">
			AND
			c.createtime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			c.createtime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		)
		order by createtime desc ,bagname
	</select>
	<select id="binUnitIdTo2" resultType="java.lang.String"
		resultMap="cc">
		select g.createtime,
    g.workid,
    g.lottype,
    b.qty,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,
    g.remark,
    case
    when b.qty > g.zh_qty then
    g.zh_qty
    else
    b.qty
    end as
    mes_qty,
    case
    when b.qty > g.zh_qty then
    b.qty - g.zh_qty
    else
    0
    end as
    chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods
    g,
    (select h.bagname, sum(h.qty) qty
    from
    sys_psl.csp_bag_hedai h,
    (select BAGNAME, sum(qty) qty
    from
    sys_psl.csp_binunitidtofg
    group by
    bagname) b
    where h.bagname1 =
    b.bagname(+)
    and deposit='蓝膜转分光'
    group by
    h.bagname) b
    where b.bagname = g.bagname
    union
    select
    g.createtime,
    g.workid,
    g.lottype,
    b.qty,
    g.bagname,
    g.flag,
    g.weight,
    g.bagweight,
    g.labelweight,
    g.jing_weight,
    g.eachweight,
    g.zh_qty,
    g.remark,
    case
    when g.zh_qty >
    g.mes_qty then
    g.mes_qty
    else
    g.zh_qty
    end as
    mes_qty,
    case
    when g.mes_qty >
    g.zh_qty then
    g.mes_qty - g.zh_qty
    else
    0
    end as
    chayi,
    g.outtime,
    g.outworkid,
    g.chulei
    from
    sys_psl.csp_pl_fgshelf_goods
    g,
    (select sum(qty)
    qty, BAGNAME
    from
    sys_psl.csp_binunitidtofg
    group by
    bagname) b
    where
    g.bagname = b.bagname
    order by createtime desc, bagname

	</select>
	<select id="selbfBag" resultType="java.lang.String" resultMap="cc">
		select * from SYS_PSL.CSP_PL_FGSHELF_GOODS where
		bagname=#{bagName,jdbcType=VARCHAR}
		and status=0
	</select>

	<select id="bfBagTo" resultType="java.lang.String" resultMap="cc">
		select * from( select rownum id,t.* from (select
		t.bagname,t.createtime,t.workid,t.odd,t.lothead,t.leixing,t.qty,t.remark,g.bin
		from
		SYS_PSL.CSP_BF_BAG t,sys_psl.csp_pl_fgshelf_goods g
		where 1=1
		and t.bagname=g.bagname
		<if test="id != null and id !='' ">
			AND
			t.createtime>=TO_DATE(#{startTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')
			AND
			t.createtime&lt;TO_DATE(#{endTime,jdbcType=VARCHAR},'yyyy-mm-dd
			hh24:mi:ss')+1
		</if>
		order by t.createtime desc)t)
		where 1=1
		<if test="barcode != null and barcode !='' ">
			AND
			id>#{startTime,jdbcType=VARCHAR}
			AND
			id
			&lt;=#{endTime,jdbcType=VARCHAR}
		</if>
	</select>

	<insert id="saveBfBag" parameterType="com.csp.tanghPailiao.entity.PutIn">
		insert into
		sys_psl.csp_bf_bag
		(bagname,createtime,workid,odd,lothead,leixing,qty,REMARK)
		values(
		#{bagName,jdbcType=VARCHAR},sysdate,#{workId,jdbcType=VARCHAR},#{odd,jdbcType=VARCHAR}
		,#{lotHead,jdbcType=VARCHAR}
		,#{leiXing,jdbcType=VARCHAR},#{qty,jdbcType=VARCHAR},#{remark,jdbcType=VARCHAR})
	</insert>

	<select id="selZong" resultType="java.lang.String" resultMap="cc">
		select * from( select t.createtime, t.leixing, t.bagname, t.lottype,
		t.qty,t.bin
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x2.*
		from (select bagname, max(createtime) as createtime
		from
		sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where
		x2.bagname = x1.bagname
		and x2.createtime = x1.createtime) t1
		where
		t.status = '0'
		and t.flag is null
		and t1.bagname = t.bagname
		and
		t1.status = 'OK'
		union
		select t.createtime, '已分光不良品' leixing, t.bagname,
		t.lottype, t.qty,t.bin
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select
		distinct x2.*
		from (select bagname, max(createtime) as createtime
		from
		sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where
		x2.bagname = x1.bagname
		and x2.createtime = x1.createtime) t1
		where
		t.status = '0'
		and t1.bagname = t.bagname
		and t1.status = 'NG'
		union all
		select t.createtime, t.leixing, t.bagname, t.lottype, t.qty,t.bin
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('分光尾料', 'NG品BIN',
		'分光NG品')
		and status = 0
		union all
		select t.createtime, t.leixing,
		t.bagname, t.lottype, t.qty,t.bin
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where status = 0
		and flag is not null
		union
		select t.createtime,
		t.leixing, t.bagname, t.lottype, t.qty,t.bin
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where status = 0
		and flag is null
		and
		leixing not in ('分光尾料', 'NG品BIN', '分光NG品', '良品BIN')
		union

		select
		i.createtime,
		'在分光' leixing,
		i.fglotid,
		i.lottype,
		nvl(i.inQty, 0) -
		nvl(o.qty, 0) now_die_qty,
		'' bin

		from (select substr(g.lottype, 0, 6)
		lottype,
		sum(g.qty) qty,
		p.fglotid,
		p.createtime
		from sys_psl.csp_fg_eqpt
		p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid =
		po.lotid
		and po.barcode = g.bagname
		group by g.lottype, p.fglotid,
		p.createtime) o,
		(select lottype, sum(inQty) inQty, fglotid, createtime
		from (select po.lottype,
		p.fglotid,
		p.createtime,
		g.bin,
		case
		when
		g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype, fglotid, createtime) i
		where
		i.fglotid = o.fglotid(+)

		union
		select kk.createtime,
		'在编带' leixing,
		kk.bdlotid bagname,
		t.lottype,

		sum(nvl(kk.qty, 0) -
		(nvl(k.qty, 0) +
		nvl(w.weiliao, 0) + nvl(w.dianji, 0) +
		nvl(w.momian, 0) + nvl(w.diliao,
		0))) sc_qty,kk.bin

		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id,
		sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty, y.createtime,g.bin
		from (select t.bdlotid, p.bagname, t.createtime
		from SYS_PSL.CSP_BD_EQPT t, sys_psl.csp_fg_eqptpro p
		where t.bdlotid =
		p.fglotid(+)
		and t.bdlotid is not null) y,
		sys_psl.csp_pl_fgshelf_goods
		g
		where y.bagname = g.bagname(+)
		group by y.bdlotid, y.createtime,g.bin)
		kk
		where t.bdlotid is not null
		and t.bdlotid = b.bd_lot_id(+)
		and
		t.bdlotid = k.lot_id(+)
		and t.bdlotid = w.bdlotid(+)
		and t.bdlotid =
		kk.bdlotid(+)
		group by t.lottype, kk.bdlotid, kk.createtime,kk.bin

		)
		<if test="leiXing != null and leiXing !='' ">
			where leixing like '%'||#{leiXing,jdbcType=VARCHAR}||'%'
		</if>
		order by leixing, lottype

	</select>

	<select id="selL2" resultType="java.lang.String" resultMap="cc">
		select lh.lottype,
		o.qty,
		now_die_qty,
		goodbin_qty,
		nvl(l.ng_qty, 0) as
		ng_qty,
		fl_qty,
		sc_qty
		from (select substr(lottype, 0, 2) as lottype,
		sum(MES_QTY) qty
		from (select lottype,
		case
		when leixing in ('卷轴转分光',
		'蓝膜转分光', '分选底板转分光', '编带尾料')
		then qty
		else MES_QTY
		end as MES_QTY
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 2)) o, --待分光散芯

		(select lh.lottype,
		nvl(i.inQty, 0) -
		nvl(o.qty, 0) now_die_qty,
		nvl(l.qty, 0) qty
		from (select
		substr(g.lottype, 0, 2) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 2)) o,
		(select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 2) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype) i,
		(select substr(po.lottype,
		0, 2) lottype, sum(g.qty) qty
		from sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where
		p.fglotid = po.fglotid
		and g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group by substr(po.lottype, 0, 2)) l,
		(select distinct lottype
		from (select distinct substr(lot_id, 1, 2) as
		lottype
		from lot@jp
		where substr(lot_id, 9, 1) = '-'
		union all
		select
		distinct substr(lothead, 1, 2) as lottype
		from sys_psl.csp_calculate))
		lh
		where lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and
		lh.lottype = o.lottype(+)
		and (o.lottype is not null or l.lottype is
		not null or
		i.lottype is not null)) i, -- 在分光散芯

		(select substr(lottype,
		0, 2) lottype, sum(qty) goodbin_qty, leixing
		from (select distinct
		t1.bagname, t.lottype, qty, leixing
		from SYS_PSL.CSP_PL_FGSHELF_GOODS
		t,
		(select distinct x2.*
		from (select bagname, max(createtime) as
		createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and x2.createtime =
		x1.createtime) t1
		where leixing = '良品BIN'
		and t.status = '0'
		and t.flag
		is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by
		leixing, substr(lottype, 0, 2)) p2, --已分光良品 DL DB DS 42893

		(select
		lh.lottype,
		sum(nvl(p2.qty3, 0) + nvl(p1.qty2, 0) + nvl(p.qty1, 0))
		ng_qty
		from (select substr(lottype, 1, 2) lottype, floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x2.*
		from
		(select bagname, max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and x2.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)) p,
		(select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty2
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)) p1,
		(select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 2)) p2,
		(select distinct lottype
		from (select
		substr(lottype, 0, 2) as lottype
		from (select lottype,
		case
		when leixing
		in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status =
		'0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 2) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 2) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 2)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 2) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 2) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 2)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x2.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and x2.createtime =
		x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)
		union all
		select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty2
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)
		union all
		select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 2)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 2) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in
		('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 2) --已分光废料
		union
		all
		select substr(t.lottype, 0, 2) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		2) --在编带散芯
		union all
		select substr(lottype, 0, 2) lottype
		from (select
		distinct t1.bagname,
		t.lottype,
		qty,
		leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x2.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and
		x2.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 2) --已分光良品
		)) lh
		where lh.lottype =
		p2.lottype(+)
		and lh.lottype = p1.lottype(+)
		and lh.lottype =
		p.lottype(+)
		and nvl(p2.qty3, 0) + nvl(p1.qty2, 0) + nvl(p.qty1, 0) !=
		0
		group by lh.lottype) l, --已分光不良品

		(select substr(lottype, 0, 2)
		lottype, sum(qty) fl_qty
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 2)) r, --已分光废料

		(select substr(t.lottype, 0, 2) lottype,

		sum(nvl(kk.qty, 0) -
		(nvl(k.qty, 0) + nvl(w.weiliao, 0) + nvl(w.dianji, 0) +
		nvl(w.momian,
		0) + nvl(w.diliao, 0))) sc_qty

		from SYS_PSL.CSP_BD_EQPT t,
		(select
		y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		2)) k, --在编带散芯

		(select distinct lottype
		from (select substr(lottype, 0,
		2) as lottype
		from (select lottype,
		case
		when leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 2) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 2) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 2)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 2) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 2) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in ('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 2)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x2.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and x2.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)
		union all
		select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty2
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 2)
		union all
		select substr(lottype, 1, 2) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in
		('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 2)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 2) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 2) --已分光废料
		union
		all
		select substr(t.lottype, 0, 2) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		2) --在编带散芯
		union all
		select substr(lottype, 0, 2) lottype
		from (select
		distinct t1.bagname, t.lottype, qty, leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x2.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x2
		where x2.bagname = x1.bagname
		and
		x2.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 2) --已分光良品
		)) lh
		where lh.lottype =
		o.lottype(+)
		and lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and lh.lottype = p2.lottype(+)
		and lh.lottype = r.lottype(+)
		and
		lh.lottype = k.lottype(+)
		and (o.lottype is not null or i.lottype is
		not null or
		l.lottype is not null or p2.lottype is not null or
		r.lottype is not null or k.lottype is not null)
		order by o.lottype


	</select>

	<select id="selL6" resultType="java.lang.String" resultMap="cc">
		--L6
		select odd,lottype,
		qty,
		now_die_qty,
		goodbin_qty,
		ng_qty,
		fl_qty,
		sc_qty
		from (select rownum odd,lottype,
		qty,
		now_die_qty,
		goodbin_qty,
		ng_qty,
		fl_qty,
		sc_qty
		from (select lh.lottype,
		o.qty,
		now_die_qty,
		goodbin_qty,
		nvl(l.ng_qty, 0) as ng_qty,
		fl_qty,
		sc_qty
		from (select
		substr(lottype, 0, 6) as lottype,
		sum(MES_QTY) qty
		from (select lottype,
		case
		when leixing in ('卷轴转分光', '蓝膜转分光', '分选底板转分光', '编带尾料')
		then qty
		else
		MES_QTY
		end as MES_QTY
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit
		= '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by substr(lottype, 0, 6)) o, --待分光散芯

		(select
		lh.lottype,
		nvl(i.inQty, 0) - nvl(o.qty, 0) now_die_qty,
		nvl(l.qty, 0)
		qty
		from (select substr(g.lottype, 0, 6) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 6)) o,
		(select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 6) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype) i,
		(select substr(po.lottype,
		0, 6) lottype, sum(g.qty) qty
		from sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where
		p.fglotid = po.fglotid
		and g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group by substr(po.lottype, 0, 6)) l,
		(select distinct lottype
		from (select distinct substr(lot_id, 1, 6) as
		lottype
		from lot@jp
		where substr(lot_id, 9, 1) = '-'
		union all
		select
		distinct substr(lothead, 1, 6) as lottype
		from sys_psl.csp_calculate))
		lh
		where lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and
		lh.lottype = o.lottype(+)
		and (o.lottype is not null or l.lottype is
		not null or
		i.lottype is not null)) i, -- 在分光散芯

		(select substr(lottype,
		0, 6) lottype, sum(qty) goodbin_qty, leixing
		from (select distinct
		t1.bagname, t.lottype, qty, leixing
		from SYS_PSL.CSP_PL_FGSHELF_GOODS
		t,
		(select distinct x6.*
		from (select bagname, max(createtime) as
		createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and x6.createtime =
		x1.createtime) t1
		where leixing = '良品BIN'
		and t.status = '0'
		and t.flag
		is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by
		leixing, substr(lottype, 0, 6)) p6, --已分光良品 DL DB DS 46893

		(select
		lh.lottype,
		sum(nvl(p6.qty3, 0) + nvl(p1.qty6, 0) + nvl(p.qty1, 0))
		ng_qty
		from (select substr(lottype, 1, 6) lottype, floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x6.*
		from
		(select bagname, max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and x6.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)) p,
		(select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty6
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)) p1,
		(select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 6)) p6,
		(select distinct lottype
		from (select
		substr(lottype, 0, 6) as lottype
		from (select lottype,
		case
		when leixing
		in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status =
		'0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 6) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 6) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 6)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 6) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 6) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 6)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x6.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and x6.createtime =
		x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)
		union all
		select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty6
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)
		union all
		select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 6)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 6) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in
		('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 6) --已分光废料
		union
		all
		select substr(t.lottype, 0, 6) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		6) --在编带散芯
		union all
		select substr(lottype, 0, 6) lottype
		from (select
		distinct t1.bagname,
		t.lottype,
		qty,
		leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x6.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and
		x6.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 6) --已分光良品
		)) lh
		where lh.lottype =
		p6.lottype(+)
		and lh.lottype = p1.lottype(+)
		and lh.lottype =
		p.lottype(+)
		and nvl(p6.qty3, 0) + nvl(p1.qty6, 0) + nvl(p.qty1, 0) !=
		0
		group by lh.lottype) l, --已分光不良品

		(select substr(lottype, 0, 6)
		lottype, sum(qty) fl_qty
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 6)) r, --已分光废料

		(select substr(t.lottype, 0, 6) lottype,

		sum(nvl(kk.qty, 0) -
		(nvl(k.qty, 0) + nvl(w.weiliao, 0) + nvl(w.dianji, 0) +
		nvl(w.momian,
		0) + nvl(w.diliao, 0))) sc_qty

		from SYS_PSL.CSP_BD_EQPT t,
		(select
		y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		6)) k, --在编带散芯

		(select distinct lottype
		from (select substr(lottype, 0,
		6) as lottype
		from (select lottype,
		case
		when leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 6) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 6) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 6)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 6) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 6) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in ('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 6)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x6.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and x6.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)
		union all
		select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty6
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 6)
		union all
		select substr(lottype, 1, 6) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in
		('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 6)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 6) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 6) --已分光废料
		union
		all
		select substr(t.lottype, 0, 6) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		6) --在编带散芯
		union all
		select substr(lottype, 0, 6) lottype
		from (select
		distinct t1.bagname, t.lottype, qty, leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x6.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x6
		where x6.bagname = x1.bagname
		and
		x6.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 6) --已分光良品
		)) lh
		where lh.lottype =
		o.lottype(+)
		and lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and lh.lottype = p6.lottype(+)
		and lh.lottype = r.lottype(+)
		and
		lh.lottype = k.lottype(+)
		and (o.lottype is not null or i.lottype is
		not null or
		l.lottype is not null or p6.lottype is not null or
		r.lottype is not null or k.lottype is not null)
		order by o.lottype
		))
		where 1=1
		<if test="lotType != null and lotType !='' ">
			AND
			lotType like #{lotType,jdbcType=VARCHAR}||'%'
		</if>
		<if test="barcode != null and barcode !='' ">
			and
			odd>#{startTime,jdbcType=VARCHAR}
			AND
			odd&lt;=#{endTime,jdbcType=VARCHAR}
		</if>

	</select>
	<select id="selL7" resultType="java.lang.String" resultMap="cc">
		--L7
		select lh.lottype,
		o.qty,
		now_die_qty,
		goodbin_qty,
		nvl(l.ng_qty, 0) as
		ng_qty,
		fl_qty,
		sc_qty
		from (select substr(lottype, 0, 7) as lottype,
		sum(MES_QTY) qty
		from (select lottype,
		case
		when leixing in ('卷轴转分光',
		'蓝膜转分光', '分选底板转分光', '编带尾料')
		then qty
		else MES_QTY
		end as MES_QTY
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 7)) o, --待分光散芯

		(select lh.lottype,
		nvl(i.inQty, 0) -
		nvl(o.qty, 0) now_die_qty,
		nvl(l.qty, 0) qty
		from (select
		substr(g.lottype, 0, 7) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 7)) o,
		(select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 7) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype) i,
		(select substr(po.lottype,
		0, 7) lottype, sum(g.qty) qty
		from sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where
		p.fglotid = po.fglotid
		and g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group by substr(po.lottype, 0, 7)) l,
		(select distinct lottype
		from (select distinct substr(lot_id, 1, 7) as
		lottype
		from lot@jp
		where substr(lot_id, 9, 1) = '-'
		union all
		select
		distinct substr(lothead, 1, 7) as lottype
		from sys_psl.csp_calculate))
		lh
		where lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and
		lh.lottype = o.lottype(+)
		and (o.lottype is not null or l.lottype is
		not null or
		i.lottype is not null)) i, -- 在分光散芯

		(select substr(lottype,
		0, 7) lottype, sum(qty) goodbin_qty, leixing
		from (select distinct
		t1.bagname, t.lottype, qty, leixing
		from SYS_PSL.CSP_PL_FGSHELF_GOODS
		t,
		(select distinct x7.*
		from (select bagname, max(createtime) as
		createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and x7.createtime =
		x1.createtime) t1
		where leixing = '良品BIN'
		and t.status = '0'
		and t.flag
		is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by
		leixing, substr(lottype, 0, 7)) p7, --已分光良品 DL DB DS 47893

		(select
		lh.lottype,
		sum(nvl(p7.qty3, 0) + nvl(p1.qty7, 0) + nvl(p.qty1, 0))
		ng_qty
		from (select substr(lottype, 1, 7) lottype, floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x7.*
		from
		(select bagname, max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and x7.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)) p,
		(select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty7
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)) p1,
		(select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 7)) p7,
		(select distinct lottype
		from (select
		substr(lottype, 0, 7) as lottype
		from (select lottype,
		case
		when leixing
		in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status =
		'0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 7) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 7) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 7)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 7) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 7) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in
		('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 7)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x7.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and x7.createtime =
		x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)
		union all
		select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty7
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)
		union all
		select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in ('分光尾料',
		'NG品BIN',
		'分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 7)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 7) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in
		('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 7) --已分光废料
		union
		all
		select substr(t.lottype, 0, 7) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		7) --在编带散芯
		union all
		select substr(lottype, 0, 7) lottype
		from (select
		distinct t1.bagname,
		t.lottype,
		qty,
		leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x7.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and
		x7.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 7) --已分光良品
		)) lh
		where lh.lottype =
		p7.lottype(+)
		and lh.lottype = p1.lottype(+)
		and lh.lottype =
		p.lottype(+)
		and nvl(p7.qty3, 0) + nvl(p1.qty7, 0) + nvl(p.qty1, 0) !=
		0
		group by lh.lottype) l, --已分光不良品

		(select substr(lottype, 0, 7)
		lottype, sum(qty) fl_qty
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 7)) r, --已分光废料

		(select substr(t.lottype, 0, 7) lottype,

		sum(nvl(kk.qty, 0) -
		(nvl(k.qty, 0) + nvl(w.weiliao, 0) + nvl(w.dianji, 0) +
		nvl(w.momian,
		0) + nvl(w.diliao, 0))) sc_qty

		from SYS_PSL.CSP_BD_EQPT t,
		(select
		y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		7)) k, --在编带散芯

		(select distinct lottype
		from (select substr(lottype, 0,
		7) as lottype
		from (select lottype,
		case
		when leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料') then
		qty
		else
		MES_QTY
		end as MES_QTY
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where deposit = '未分光'
		and status = '0'
		and leixing in ('卷轴转分光',
		'蓝膜转分光',
		'分选底板转分光',
		'编带尾料',
		'底板散芯'))
		group by
		substr(lottype, 0, 7) --待分光散芯
		union all
		select distinct lottype
		from
		(select substr(g.lottype, 0, 7) lottype, sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_label po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.lotid
		and po.barcode
		= g.bagname
		group by substr(g.lottype, 0, 7)
		union all
		select lottype,
		sum(inQty) inQty
		from (select substr(po.lottype, 0, 7) lottype,
		case
		when g.leixing = '底板散芯' then
		g.mes_qty
		when g.leixing in
		('分光尾料',
		'NG品BIN',
		'分光NG品',
		'分光地料',
		'分光废料',
		'良品BIN',
		'报废BIN',
		'蓝膜转分光',
		'分选底板转分光',
		'卷轴转分光') then
		g.qty
		when g.leixing = '编带尾料' then
		g.zh_qty
		end inQty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname)
		group by lottype
		union all
		select
		substr(po.lottype, 0, 7) lottype,
		sum(g.qty) qty
		from
		sys_psl.csp_fg_eqpt p,
		sys_psl.csp_fg_eqptpro po,
		sys_psl.csp_pl_fgshelf_goods g
		where p.fglotid = po.fglotid
		and
		g.bagname = po.bagname
		and leixing in ('分光NG品', 'NG品BIN', '分光尾料')
		group
		by substr(po.lottype, 0, 7)) -- 在分光散芯
		union all
		select lottype
		from
		(select *
		from (select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as
		qty1
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((select distinct x7.*
		from
		(select bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and x7.createtime = x1.createtime)) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t1.status = 'NG'
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)
		union all
		select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty7
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		((SELECT
		distinct bagname, STATUS
		FROM SYS_PSL.CSP_PL_QC
		WHERE CREATETIME IN
		(SELECT CREATETIME
		FROM (SELECT MAX(CREATETIME) CREATETIME,
		BAGNAME
		FROM
		SYS_PSL.CSP_PL_QC
		GROUP BY BAGNAME)))) t1
		where leixing = '良品BIN'
		and
		t.status = '0'
		and t.flag is not null
		and t.bagname = t1.bagname
		group by
		substr(lottype, 1, 7)
		union all
		select substr(lottype, 1, 7) lottype,
		floor(sum(qty)) as qty3
		from SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where
		leixing in
		('分光尾料', 'NG品BIN', '分光NG品')
		AND STATUS = '0'
		group by
		substr(lottype, 1, 7)))
		group by lottype --已分光不良品
		union all
		select
		substr(lottype, 0, 7) lottype
		from (select *
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t
		where leixing in ('报废BIN', '分光地料',
		'分光废料')
		and status = '0')
		group by substr(lottype, 0, 7) --已分光废料
		union
		all
		select substr(t.lottype, 0, 7) lottype
		from SYS_PSL.CSP_BD_EQPT t,
		(select y.bd_lot_id, sum(u.qty) taqty
		from SYS_PSL.CSP_CHK_BAGNAME_INFO
		y,
		sys_psl.csp_pl_fgshelf_goods u
		where y.bag_name = u.bagname
		group by
		y.bd_lot_id) b, --总投入
		(select sum(qty) qty, lot_id
		from
		SYS_PSL.CSP_TAPE_CHECK_INFO t
		where lot_id is not null
		group by lot_id
		--卷轴产出
		) k,
		sys_psl.csp_bd_weiliao w,
		(select y.bdlotid, sum(g.qty) as
		qty
		from (select t.bdlotid, p.bagname
		from SYS_PSL.CSP_BD_EQPT t,
		sys_psl.csp_fg_eqptpro p
		where t.bdlotid = p.fglotid(+)
		and t.bdlotid is
		not null) y,
		sys_psl.csp_pl_fgshelf_goods g
		where y.bagname =
		g.bagname(+)
		group by y.bdlotid) kk
		where t.bdlotid is not null
		and
		t.bdlotid = b.bd_lot_id(+)
		and t.bdlotid = k.lot_id(+)
		and t.bdlotid =
		w.bdlotid(+)
		and t.bdlotid = kk.bdlotid(+)
		group by substr(t.lottype, 0,
		7) --在编带散芯
		union all
		select substr(lottype, 0, 7) lottype
		from (select
		distinct t1.bagname, t.lottype, qty, leixing
		from
		SYS_PSL.CSP_PL_FGSHELF_GOODS t,
		(select distinct x7.*
		from (select
		bagname,
		max(createtime) as createtime
		from sys_psl.csp_pl_qc
		group by
		bagname) x1,
		sys_psl.csp_pl_qc x7
		where x7.bagname = x1.bagname
		and
		x7.createtime = x1.createtime) t1
		where leixing = '良品BIN'
		and t.status =
		'0'
		and t.flag is null
		and t1.bagname = t.bagname
		and t1.status = 'OK')
		group by leixing, substr(lottype, 0, 7) --已分光良品
		)) lh
		where lh.lottype =
		o.lottype(+)
		and lh.lottype = i.lottype(+)
		and lh.lottype = l.lottype(+)
		and lh.lottype = p7.lottype(+)
		and lh.lottype = r.lottype(+)
		and
		lh.lottype = k.lottype(+)
		and (o.lottype is not null or i.lottype is
		not null or
		l.lottype is not null or p7.lottype is not null or
		r.lottype is not null or k.lottype is not null)
		order by o.lottype


	</select>

	<select id="putInDFGLabel" resultType="java.lang.String"
		resultMap="cc">
		select * from SYS_PSL.CSP_PL_FGSHELF_GOODS t where
		lotid=#{lotId,jdbcType=VARCHAR}

	</select>

	<select id="selBinToFG" resultType="java.lang.String" resultMap="cc">
		select t.*, t.rowid from SYS_PSL.CSP_BINUNITIDTOFG t where
		binunitid=#{binUnitId,jdbcType=VARCHAR}
	</select>

	<select id="selBinToFG1" resultType="java.lang.String"
		resultMap="cc">
		select g.bagname,g.lotType,g.qty,g.jing_weight AS jingWeight
		from SYS_PSL.CSP_BINUNITIDTOFG t,
		sys_psl.csp_pl_fgshelf_goods g
		where
		t.bagname=g.bagname
		and
		binUnitId=#{binUnitId,jdbcType=VARCHAR}
	</select>

	<select id="selBarcodeToFG1" resultType="java.lang.String"
		resultMap="cc">

		select g.bagname,g.lotType,g.qty,g.jing_weight AS jingWeight
		from SYS_PSL.CSP_BARCODETOFG t,
		sys_psl.csp_pl_fgshelf_goods g
		where
		t.bagname=g.bagname
		and barcode=
		#{binUnitId,jdbcType=VARCHAR}
	</select>

	<select id="fenxuanToFg1" resultType="java.lang.String"
		resultMap="cc">

		select g.bagname,g.lotType,g.qty,g.jing_weight AS jingWeight
		from SYS_PSL.CSP_FENXUANTOFG t,
		sys_psl.csp_pl_fgshelf_goods g
		where
		t.bagname=g.bagname
		and barcode=
		#{binUnitId,jdbcType=VARCHAR}
	</select>

	<select id="bdweiliaoLabel" resultType="java.lang.String"
		resultMap="cc">
		select * from sys_psl.csp_bd_weiliao t,
		sys_psl.csp_pl_fgshelf_goods g
		where t.bdlotid=g.lotid
		and bdlotid=
		#{bdLotId,jdbcType=VARCHAR}
	</select>


	<select id="bagHeTo" resultType="java.lang.String" resultMap="cc">
		select g.createtime, --日期
		g.workid, --操作人
		g.lottype, --种类
		g.leiXing, --类型
		h.bagname, -- 合并袋号
		h.bagname1, --原袋号
		h.qty as sc_qty , --原始数量
		k.total_out_die_qty as qty, --合并数量
		g.flag, --状态
		g.weight, --重量
		g.bagweight, --袋子重量
		g.labelweight,
		--标签重量
		g.jing_weight, --净重
		g.eachweight, --单颗重量
		g.zh_qty, --重量转换颗粒数
		case
		when g.zh_qty >
		k.total_out_die_qty then
		k.total_out_die_qty
		else
		g.zh_qty
		end as
		now_die_qty, --计算数量
		case
		when k.total_out_die_qty >=
		g.zh_qty then
		k.total_out_die_qty - g.zh_qty
		else
		0
		end as ng_qty, --损失数量
		g.outtime,
		--出库时间
		g.outworkid, --出库人
		g.chulei --出库类型

		from (select
		bagname, sum(qty)
		as
		total_out_die_qty
		from sys_psl.csp_bag_hedai
		group
		by bagname) k,
		SYS_PSL.CSP_PL_FGSHELF_GOODS g,
		sys_psl.csp_bag_hedai h
		where h.bagname
		= g.bagname(+)
		and h.bagname = k.bagname(+)
		order by g.createtime desc
	</select>

</mapper>